<!doctype html><html lang="fr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Commande - Vite & Gourmand</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/style.css"></head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark sticky-top" style="background:rgba(0,0,0,.6)">
<div class="container"><a class="navbar-brand fw-bold" href="/">Vite &amp; Gourmand</a>
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="nav">
<ul class="navbar-nav ms-auto gap-2">
<li class="nav-item"><a class="nav-link" href="/menus.html">Menus</a></li>
<li class="nav-item"><a class="nav-link" href="/contact.html">Contact</a></li>
<li class="nav-item"><a class="nav-link" href="/dashboard.html">Espace</a></li>
<li class="nav-item"><a class="nav-link" href="/login.html" id="navLogin">Connexion</a></li>
<li class="nav-item"><button class="btn btn-sm btn-outline-light" id="navLogout" style="display:none">Déconnexion</button></li>
</ul></div></div></nav>
<main class="container py-4"><div id='wrap' class='card p-3' aria-live='polite'></div></main>
<footer class="py-4" style="border-top:1px solid #2a2d33"><div class="container d-flex flex-column flex-md-row justify-content-between gap-3">
<div><div class="fw-bold">Horaires</div><div>Lun–Dim : 09:00–19:00</div></div>
<div class="d-flex gap-3"><a href="/legal.html">Mentions légales</a><a href="/cgv.html">CGV</a></div></div></footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">import{getUser,clearSession}from"/js/api.js";const u=getUser();const l=document.getElementById("navLogin");const o=document.getElementById("navLogout");
if(u){l.style.display="none";o.style.display="inline-block"};o?.addEventListener("click",()=>{clearSession();location.href="/"});</script>

<script type="module">
import { api, requireLogin } from "/js/api.js";
if(!requireLogin()) {}
const menuId=new URLSearchParams(location.search).get("menuId");
const wrap=document.getElementById("wrap");
const r=await api("/api/menus/"+menuId);
const m=r.menu;
wrap.innerHTML=`
<div class="fw-bold">${m.title}</div>
<div class="text-secondary">Min ${m.min_people} • Prix ${Number(m.base_price).toFixed(2)} €</div>
<div class="alert alert-warning mt-3"><b>Conditions :</b> ${m.conditions}</div>
<div class="row g-2">
  <div class="col-md-6"><label class="form-label">Date</label><input id="date" class="form-control" type="date"></div>
  <div class="col-md-6"><label class="form-label">Heure</label><input id="time" class="form-control" type="time"></div>
  <div class="col-12"><label class="form-label">Adresse</label><input id="addr" class="form-control"></div>
  <div class="col-md-6"><label class="form-label">Ville</label><input id="city" class="form-control" value="Bordeaux"></div>
  <div class="col-md-6"><label class="form-label">Km (si hors Bordeaux)</label><input id="km" class="form-control" type="number" step="0.01" value="0"></div>
  <div class="col-md-6"><label class="form-label">Personnes</label><input id="people" class="form-control" type="number" min="${m.min_people}" value="${m.min_people}"></div>
</div>
<div class="mt-3"><div class="fw-semibold">Détail prix</div><div id="pricing" class="text-secondary small"></div></div>
<button class="btn btn-vg mt-3" id="btn">Valider</button>
<div id="msg" class="mt-2"></div>
`;
function compute(){
  const people=Number(peopleEl.value);
  const km=Number(kmEl.value);
  const city=cityEl.value.trim().toLowerCase();
  const delivery=(city==="bordeaux")?0:(5+0.59*Math.max(0,km));
  const menuPrice=Number(m.base_price);
  const discount=(people>=Number(m.min_people)+5)?(menuPrice*0.10):0;
  const total=(menuPrice-discount)+delivery;
  pricing.innerHTML=`Menu ${menuPrice.toFixed(2)}€ • Réduction -${discount.toFixed(2)}€ • Livraison ${delivery.toFixed(2)}€ • <b>Total ${total.toFixed(2)}€</b>`;
}
const peopleEl=document.getElementById("people");
const kmEl=document.getElementById("km");
const cityEl=document.getElementById("city");
const pricing=document.getElementById("pricing");
const msg=document.getElementById("msg");
["input","change"].forEach(ev=>{peopleEl.addEventListener(ev,compute);kmEl.addEventListener(ev,compute);cityEl.addEventListener(ev,compute);});
compute();
btn.addEventListener("click", async ()=>{
  msg.textContent="";
  try{
    const out=await api("/api/orders",{method:"POST",body:{
      menuId:Number(menuId),
      peopleCount:Number(peopleEl.value),
      prestationDate:date.value,
      prestationTime:time.value,
      prestationAddress:addr.value.trim(),
      prestationCity:cityEl.value.trim(),
      distanceKm:Number(kmEl.value)
    }});
    msg.innerHTML=`<div class="text-success">Commande créée (#${out.orderId}).</div>`;
    setTimeout(()=>location.href="/dashboard.html",700);
  }catch(e){ msg.innerHTML=`<div class="text-danger">${e.message}</div>`; }
});
</script>
</body></html>