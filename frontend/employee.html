<!doctype html><html lang="fr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Employé - Vite & Gourmand</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/style.css"></head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark sticky-top" style="background:rgba(0,0,0,.6)">
<div class="container"><a class="navbar-brand fw-bold" href="/">Vite &amp; Gourmand</a>
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="nav">
<ul class="navbar-nav ms-auto gap-2">
<li class="nav-item"><a class="nav-link" href="/menus.html">Menus</a></li>
<li class="nav-item"><a class="nav-link" href="/contact.html">Contact</a></li>
<li class="nav-item"><a class="nav-link" href="/dashboard.html">Espace</a></li>
<li class="nav-item"><a class="nav-link" href="/login.html" id="navLogin">Connexion</a></li>
<li class="nav-item"><button class="btn btn-sm btn-outline-light" id="navLogout" style="display:none">Déconnexion</button></li>
</ul></div></div></nav>
<main class="container py-4">
<h1 class="h4">Espace Employé</h1>
<div class="row g-3">
  <div class="col-lg-4">
    <div class="card p-3">
      <h2 class="h6">Filtrer</h2>
      <label class="form-label">Statut</label>
      <select id="status" class="form-select"><option value="">Tous</option>
        <option>reçue</option><option>accepté</option><option>en préparation</option><option>en cours de livraison</option><option>livré</option><option>en attente du retour de matériel</option><option>terminée</option><option>annulée</option>
      </select>
      <label class="form-label mt-2">Email client</label><input id="email" class="form-control" type="email">
      <button class="btn btn-vg w-100 mt-3" id="apply">Appliquer</button>
    </div>
    <div class="card p-3 mt-3"><h2 class="h6">Avis à valider</h2><div id="pending" class="d-grid gap-2"></div></div>
  </div>
  <div class="col-lg-8"><div class="card p-3"><h2 class="h6">Commandes</h2><div id="list" class="d-grid gap-2" aria-live="polite"></div></div></div>
</div>
</main>
<footer class="py-4" style="border-top:1px solid #2a2d33"><div class="container d-flex flex-column flex-md-row justify-content-between gap-3">
<div><div class="fw-bold">Horaires</div><div>Lun–Dim : 09:00–19:00</div></div>
<div class="d-flex gap-3"><a href="/legal.html">Mentions légales</a><a href="/cgv.html">CGV</a></div></div></footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">import{getUser,clearSession}from"/js/api.js";const u=getUser();const l=document.getElementById("navLogin");const o=document.getElementById("navLogout");
if(u){l.style.display="none";o.style.display="inline-block"};o?.addEventListener("click",()=>{clearSession();location.href="/"});</script>

<script type="module">
import { api, getUser, requireLogin } from "/js/api.js";
if(!requireLogin()) {}
const u=getUser(); if(u.role==="user") location.href="/dashboard.html";
const list=document.getElementById("list"); const pending=document.getElementById("pending");
async function loadOrders(){
  const p=new URLSearchParams();
  if(status.value) p.set("status",status.value);
  if(email.value.trim()) p.set("email",email.value.trim());
  const r=await api("/api/orders?"+p.toString());
  list.innerHTML=r.items.map(o=>`<div class="card p-2"><div class="fw-semibold">#${o.id} • ${o.menu_title}</div>
  <div class="small text-secondary">${o.email}</div>
  <div class="small">Statut: <b>${o.status}</b> • Total: ${Number(o.total_price).toFixed(2)} €</div>
  <div class="d-flex flex-wrap gap-2 mt-2">
    ${["accepté","en préparation","en cours de livraison","livré","en attente du retour de matériel","terminée"].map(s=>`<button class="btn btn-sm btn-outline-light" data-s="${s}" data-id="${o.id}">${s}</button>`).join("")}
    <button class="btn btn-sm btn-outline-danger" data-c="${o.id}">Annuler</button>
  </div></div>`).join("")||'<div class="text-secondary">Aucune commande.</div>';
}
async function loadPending(){
  const r=await api("/api/reviews/pending");
  pending.innerHTML=r.items.map(x=>`<div class="card p-2"><div class="fw-semibold">${x.first_name} ${x.last_name} • ${"★".repeat(x.rating)}${"☆".repeat(5-x.rating)}</div>
  <div>${x.comment}</div><div class="d-flex gap-2 mt-2"><button class="btn btn-sm btn-vg" data-v="true" data-r="${x.id}">Valider</button>
  <button class="btn btn-sm btn-outline-danger" data-v="false" data-r="${x.id}">Refuser</button></div></div>`).join("")||'<div class="text-secondary">Aucun avis.</div>';
}
apply.addEventListener("click",loadOrders);
document.addEventListener("click", async (ev)=>{
  const b=ev.target.closest("button"); if(!b) return;
  if(b.dataset.s){ await api(`/api/orders/${b.dataset.id}/status`,{method:"POST",body:{status:b.dataset.s}}); await loadOrders(); }
  if(b.dataset.c){
    const reason=prompt("Motif (obligatoire) :"); if(!reason) return;
    const contactMode=prompt("Mode de contact (gsm/mail) :")||"mail";
    await api(`/api/orders/${b.dataset.c}/cancel`,{method:"POST",body:{reason,contactMode}}); await loadOrders();
  }
  if(b.dataset.r){ await api(`/api/reviews/${b.dataset.r}/validate`,{method:"POST",body:{isValidated:b.dataset.v==="true"}}); await loadPending(); }
});
await loadOrders(); await loadPending();
</script>
</body></html>